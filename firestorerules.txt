rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users collection: hanya user yang login bisa baca/tulis data sendiri
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Admin bisa membaca semua data user
      allow read: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Presensi collection: user hanya bisa menambah data sendiri, admin bisa baca semua
    match /presensi/{docId} {
      allow create: if request.auth != null && request.resource.data.uid == request.auth.uid;
      allow read: if request.auth != null && 
        (resource.data.uid == request.auth.uid || 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }
    
    // Cuti collection: user bisa buat pengajuan, admin bisa update status
    match /cuti/{docId} {
      allow create: if request.auth != null && request.resource.data.uid == request.auth.uid;
      allow read: if request.auth != null && 
        (resource.data.uid == request.auth.uid || 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
      allow update: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Notifikasi collection: user bisa baca notifikasi untuk dirinya, admin bisa baca notifikasi admin
    match /notifikasi/{docId} {
      allow read: if request.auth != null && 
        (resource.data.uid == request.auth.uid || 
         resource.data.targetRole == 'admin' && 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
         resource.data.targetRole == 'karyawan');
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Aturan waktu default: hanya admin yang bisa mengubah
    match /aturanwaktudefault/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Aturan waktu user: hanya admin yang bisa mengubah
    match /aturanwaktuuser/{userId} {
      allow read: if request.auth != null && 
        (request.auth.uid == userId || 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Pengumuman collection: hanya admin yang bisa membuat, user bisa baca yang ditujukan kepadanya
    match /pengumuman/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}