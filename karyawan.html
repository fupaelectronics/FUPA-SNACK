<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Presensi FUPA — Karyawan</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#FFB300" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:FILL,GRAD@1,200" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <style>
    /* (UI styles kept similar to reference) */
    body{font-family:Inter,system-ui;margin:0;background:linear-gradient(180deg,#FFF59D,#FFB300);color:#222}
    header{display:flex;justify-content:space-between;padding:12px}
    .card{background:#fff;border-radius:12px;padding:12px;margin:12px}
    .btn{background:linear-gradient(135deg,#FFB300,#FF8F00);color:#fff;padding:10px;border-radius:10px;border:none;cursor:pointer}
    #toast{display:none;position:fixed;left:50%;bottom:12px;transform:translateX(-50%);padding:8px 12px;color:#fff;border-radius:8px}
  </style>
</head>
<body>
  <header>
    <div><b>Presensi Karyawan</b><div id="serverTime" style="font-size:12px;opacity:.8">—</div></div>
    <div>
      <button id="notifBtn" class="btn">Notifikasi <span id="notifBadge" style="background:red;color:#fff;border-radius:10px;padding:2px 6px;margin-left:6px">0</span></button>
      <button id="profileBtn" class="btn">Profil</button>
    </div>
  </header>

  <div class="card">
    <h3>Ambil presensi</h3>
    <div><span id="statusText">—</span> | <span id="locText">koordinat: -</span></div>
    <div style="margin-top:10px">
      <video id="video" autoplay playsinline style="width:100%;max-height:320px;background:#111"></video>
      <canvas id="canvas" style="display:none"></canvas>
    </div>
    <div style="margin-top:10px">
      <select id="jenis"><option value="berangkat">Presensi berangkat</option><option value="pulang">Presensi pulang</option></select>
      <input type="file" id="fileInput" accept="image/*" style="display:none" />
      <button id="snapBtn" class="btn">Ambil Selfie</button>
      <button id="uploadBtn" class="btn" disabled>Upload</button>
    </div>
  </div>

  <div class="card">
    <h3>Riwayat presensi</h3>
    <select id="historyFilter"><option value="20">20</option><option value="50">50</option><option value="all">All</option></select>
    <div id="logList"></div>
  </div>

  <div class="card">
    <button id="cutiFab" class="btn">Ajukan Cut i</button>
  </div>

  <div id="toast"></div>

  <!-- Firebase + libs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <!-- CompressorJS -->
  <script src="https://cdn.jsdelivr.net/npm/compressorjs@1.1.1/dist/compressor.min.js"></script>

  <!-- app.js (shared logic) -->
  <script src="app.js"></script>

  <script>
    // initialize firebase (same config)
    const firebaseConfig = {
      apiKey: "AIzaSyApYdiUlLMb9ihBkLnCjDpLJHqYFRFS3Fw",
      authDomain: "fupa-snack.firebaseapp.com",
      projectId: "fupa-snack",
      storageBucket: "fupa-snack.firebasestorage.app",
      messagingSenderId: "972524876738",
      appId: "1:972524876738:web:dd0d57dd8bf2d8a8dd9c5b"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const toastEl = document.getElementById('toast');
    function toast(msg, color='#111') {
      toastEl.style.backgroundColor = color;
      toastEl.textContent = msg;
      toastEl.style.display = 'block';
      setTimeout(()=> toastEl.style.display='none', 3000);
    }

    // require auth state
    auth.onAuthStateChanged(async user => {
      if (!user) {
        // not logged in -> redirect to login
        toast('Belum login — mengarahkan ke login', '#c62828');
        setTimeout(()=> location.href='index.html', 800);
        return;
      }
      // load profile
      window.userProfile = await FupaApp.loadProfileAndEnsure(user.uid);
      // attach certain client fields
      window.currentUser = {
        uid: user.uid,
        email: user.email,
        name: window.userProfile.name || user.email
      };
      // start server time tick
      updateServerTime();
      setInterval(updateServerTime, 1000);
      // start camera
      startCamera();
      // notifications listener
      window.unsubscribeNotifs = FupaApp.listenNotificationsFor({uid:user.uid});
      window.onNotificationsUpdate = (arr) => {
        // filter to those relevant to this user
        const unread = arr.filter(n => !n.isRead && (!n.targetRole || n.targetRole==='karyawan' || n.uid===user.uid)).length;
        document.getElementById('notifBadge').textContent = unread;
      };
      loadHistory();
    });

    // server time via Date (client) visible; for true serverTime, use FupaApp.getServerTimestamp()
    function updateServerTime() {
      const now = new Date();
      document.getElementById('serverTime').textContent = now.toLocaleString('id-ID');
    }

    // Camera
    async function startCamera() {
      const video = document.getElementById('video');
      try {
        const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
        video.srcObject = s;
      } catch (e) {
        console.error('Camera error', e);
        toast('Tidak dapat mengakses kamera', '#c62828');
      }
    }

    document.getElementById('snapBtn').addEventListener('click', () => {
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      canvas.toBlob((blob) => {
        // store selected file in window for upload step
        window.latestSelfieBlob = blob;
        document.getElementById('uploadBtn').disabled = false;
        toast('Selfie diambil', '#2e7d32');
      }, 'image/jpeg', 0.9);
    });

    document.getElementById('uploadBtn').addEventListener('click', async () => {
      if (!window.latestSelfieBlob) return toast('Ambil selfie dulu', '#c62828');
      const jenis = document.getElementById('jenis').value;
      const user = { uid: firebase.auth().currentUser.uid, name: (window.userProfile && window.userProfile.name) || firebase.auth().currentUser.email };
      document.getElementById('uploadBtn').disabled = true;
      const res = await FupaApp.submitPresensi(window.latestSelfieBlob, jenis, user);
      if (res.ok) loadHistory();
      document.getElementById('uploadBtn').disabled = false;
    });

    // load history
    async function loadHistory() {
      const uid = firebase.auth().currentUser.uid;
      const q = db.collection('presensi').where('uid','==',uid).orderBy('waktu','desc').limit(50);
      const snap = await q.get();
      const container = document.getElementById('logList');
      container.innerHTML = '';
      snap.forEach(d => {
        const r = d.data();
        const node = document.createElement('div');
        node.innerHTML = `<div style="padding:8px;border-bottom:1px solid #eee">
          <div><b>${r.jenis}</b> — ${r.status}</div>
          <div style="font-size:13px;color:#666">${r.waktu && r.waktu.toDate ? r.waktu.toDate().toLocaleString('id-ID') : r.waktu}</div>
        </div>`;
        container.appendChild(node);
      });
    }

    // Cuti
    document.getElementById('cutiFab').addEventListener('click', async () => {
      const tanggal = prompt('Tanggal cuti (YYYY-MM-DD):', new Date().toISOString().slice(0,10));
      if (!tanggal) return;
      const jenis = prompt('Jenis (cuti/sakit/izin):','cuti');
      const keterangan = prompt('Keterangan (opsional):','');
      await FupaApp.ajukanCuti(firebase.auth().currentUser.uid, window.currentUser.name, tanggal, jenis, keterangan);
      loadHistory();
    });

    // Notif & profile buttons
    document.getElementById('notifBtn').addEventListener('click', async () => {
      // fetch notifikasi for this uid or targetRole='karyawan'
      const q = db.collection('notifikasi').orderBy('timestamp','desc').limit(40);
      const snap = await q.get();
      let out = '';
      snap.forEach(d => {
        const r = d.data();
        if (r.uid === firebase.auth().currentUser.uid || r.targetRole === 'karyawan' || !r.targetRole) {
          out += `${r.pesan} — ${r.timestamp && r.timestamp.toDate ? r.timestamp.toDate().toLocaleString('id-ID') : ''}\n`;
          // mark read
          db.collection('notifikasi').doc(d.id).update({ isRead: true }).catch(()=>{});
        }
      });
      alert(out || 'Tidak ada notifikasi');
    });

    document.getElementById('profileBtn').addEventListener('click', async () => {
      // simple profile edit prompts per PEDOMAN
      const name = prompt('Nama lengkap:', (window.userProfile && window.userProfile.name) || '');
      const alamat = prompt('Alamat:', (window.userProfile && window.userProfile.alamat) || '');
      await db.collection('users').doc(firebase.auth().currentUser.uid).update({ name, alamat });
      toast('Profil disimpan', '#2e7d32');
      window.userProfile.name = name;
      window.userProfile.alamat = alamat;
    });

    // Logout on double-click header (quick act)
    document.querySelector('header').addEventListener('dblclick', async () => {
      await auth.signOut();
      location.href='index.html';
    });
  </script>
</body>
</html>