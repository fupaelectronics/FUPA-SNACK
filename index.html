<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Presensi FUPA — Masuk</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#FFC107" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:FILL,GRAD@1,200" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <style>
    /* (Styles copied from your reference; unchanged in intent) */
    :root{ --bg1:#FFF59D; --bg2:#FFD54F; --bg3:#FFB300; --card:#ffffffcc; --txt:#222; --soft-shadow: 0 10px 30px rgba(0,0,0,.15);}
    *{box-sizing:border-box}
    body{margin:0; font-family:Inter,system-ui; color:var(--txt); background: radial-gradient(1200px 800px at 80% -10%, var(--bg3), transparent), radial-gradient(1000px 600px at 0% 0%, var(--bg2), transparent), linear-gradient(180deg, var(--bg1), var(--bg2) 60%, var(--bg3)); min-height:100vh}
    .card{width:min(520px,92vw); margin:40px auto; background:var(--card); padding:24px; border-radius:16px; box-shadow:var(--soft-shadow)}
    .input{display:flex; gap:10px; align-items:center; padding:10px; background:#fff; border-radius:10px; margin:10px 0}
    .btn{background:linear-gradient(135deg,#FFB300,#FF8F00); color:#fff; padding:10px 12px; border:none; border-radius:12px; cursor:pointer; font-weight:700}
    .toast{position:fixed; left:50%; bottom:12px; transform:translateX(-50%); display:none; padding:10px 14px; color:#fff; border-radius:10px}
  </style>
</head>
<body>
  <div class="card">
    <h1>Presensi FUPA — Masuk</h1>
    <p>Masuk menggunakan email dan kata sandi. Jika mengalami kendala, hubungi admin.</p>
    <div class="input"><span class="material-symbols-rounded">mail</span><input id="email" type="email" placeholder="Email kerja" /></div>
    <div class="input"><span class="material-symbols-rounded">lock</span><input id="password" type="password" placeholder="Kata sandi" /></div>
    <div style="display:flex; gap:10px;">
      <button id="loginBtn" class="btn">Masuk</button>
      <button id="guestBtn" class="btn" style="background:#666">Tes Tanpa Auth</button>
    </div>
    <div id="successMessage" style="display:none;color:green;margin-top:10px"></div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // Firebase config — from PEDOMAN. Replace if necessary.
    const firebaseConfig = {
      apiKey: "AIzaSyApYdiUlLMb9ihBkLnCjDpLJHqYFRFS3Fw",
      authDomain: "fupa-snack.firebaseapp.com",
      projectId: "fupa-snack",
      storageBucket: "fupa-snack.firebasestorage.app",
      messagingSenderId: "972524876738",
      appId: "1:972524876738:web:dd0d57dd8bf2d8a8dd9c5b"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // helper
    const toastEl = document.getElementById('toast');
    function toast(msg, color='#111') {
      toastEl.style.backgroundColor = color;
      toastEl.textContent = msg;
      toastEl.style.display = 'block';
      setTimeout(()=> toastEl.style.display='none', 3000);
    }

    // Role fallback sets (from PEDOMAN)
    const ADMIN_UIDS = new Set(['O1SJ7hYop3UJjDcsA3JqT29aapI3','uB2XsyM6fXUj493cRlHCqpe2fxH3']);
    const KARYAWAN_UIDS = new Set([
      '7NJ9xoMgQlUbi68CMQWFN5bYvF62','Jn7Fghq1fkNGx8f0z8sTGkxH94E2','vB3i5h6offMxQslKf2U0J1ElpWS2',
      'tIGmvfnqtxf5QJlfPUy9O1uzHJ73','zl7xjZaI6BdCLT7Z2WA34oTcFV42','NainrtLo3BWRSJKImgIBYNLJEIv2',
      '9Y9s8E23TNbMlO9vZBVKQCGGG0Z2','dDq2zTPs12Tn2v0Zh4IdObDcD7g2','Tkqf05IzI9UTvy4BF0nWtZwbz8j2',
      'pMbjHKjsZLWtNHi7PTc8cDJ254w2','G0qTjLBc6MeRMPziNTzIT6N32ZM2'
    ]);

    function redirectByRole(uid, usersDocRole) {
      if (usersDocRole === 'admin' || ADMIN_UIDS.has(uid)) return 'admin.html';
      if (usersDocRole === 'karyawan' || KARYAWAN_UIDS.has(uid)) return 'karyawan.html';
      // default fallback: to karyawan.html
      return 'karyawan.html';
    }

    // Login flow (auth logic must be here per PEDOMAN)
    document.getElementById('loginBtn').addEventListener('click', async () => {
      const email = document.getElementById('email').value.trim();
      const pass = document.getElementById('password').value.trim();
      if (!email || !pass) { toast('Isi email & password'); return; }
      try {
        document.getElementById('loginBtn').disabled = true;
        toast('Mencoba masuk...');
        const cred = await auth.signInWithEmailAndPassword(email, pass);
        const user = cred.user;
        // Fetch users/{uid} to determine role
        const udoc = await db.collection('users').doc(user.uid).get();
        let role = null;
        if (udoc.exists) {
          role = udoc.data().role;
        } else {
          // create minimal user doc so that later pages will find it
          const inferred = ADMIN_UIDS.has(user.uid) ? 'admin' : 'karyawan';
          await db.collection('users').doc(user.uid).set({
            uid: user.uid,
            email: user.email,
            name: "",
            alamat: "",
            role: inferred,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          role = inferred;
        }
        const dest = redirectByRole(user.uid, role);
        toast('Login berhasil, mengalihkan...');
        setTimeout(()=> window.location.href = dest, 1000);
      } catch (e) {
        console.error(e);
        document.getElementById('loginBtn').disabled = false;
        toast('Login gagal. Periksa kredensial.');
      }
    });

    // Guest quick link for testing without auth (development)
    document.getElementById('guestBtn').addEventListener('click', () => {
      // navigate to karyawan.html as non-auth test. Note: pages expect auth; some features will not work
      window.location.href = 'karyawan.html';
    });

    // allow Enter to submit
    document.getElementById('password').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') document.getElementById('loginBtn').click();
    });
  </script>
</body>
</html>