<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Presensi FUPA â€” Admin</title>
  <meta name="theme-color" content="#FFB300" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="FUPA Presensi">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:FILL,GRAD@1,200" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <style>
    /* CSS sama seperti yang diberikan */
  </style>
</head>
<body>
  <!-- HTML sama seperti yang diberikan -->

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="riwayatpresensi.js"></script>
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyApYdiUlLMb9ihBkLnCjDpLJHqYFRFS3Fw",
      authDomain: "fupa-snack.firebaseapp.com",
      projectId: "fupa-snack",
      storageBucket: "fupa-snack.firebasestorage.app",
      messagingSenderId: "972524876738",
      appId: "1:972524876738:web:dd0d57dd8bf2d8a8dd9c5b"
    };

    // Inisialisasi Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // State aplikasi
    let currentUser = null;
    let userData = null;
    let presenceHistory = [];

    // Util UI
    const $ = (sel) => document.querySelector(sel);
    const toast = (msg, type = 'info') => {
      const t = $("#toast");
      if (!t) return alert(msg);
      
      // Set background color berdasarkan tipe pesan
      const colors = {
        success: '#2e7d32',
        error: '#c62828',
        warning: '#f9a825',
        info: '#111'
      };
      
      t.style.backgroundColor = colors[type] || colors.info;
      t.textContent = msg;
      t.style.display = "block";
      setTimeout(() => { t.style.display = "none"; }, 3000);
    };

    // Fungsi untuk mendapatkan waktu server
    async function getServerTimestamp() {
      try {
        const docRef = db.collection('serverTime').doc('current');
        await docRef.set({ timestamp: firebase.firestore.FieldValue.serverTimestamp() });
        const doc = await docRef.get();
        return doc.exists ? doc.data().timestamp.toDate() : new Date();
      } catch (error) {
        console.error("Error getting server timestamp:", error);
        return new Date(); // Fallback ke waktu lokal
      }
    }

    // Fungsi untuk update waktu server
    async function updateServerTime() {
      try {
        const serverTime = await getServerTimestamp();
        const options = { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          timeZone: 'Asia/Jakarta'
        };
        $('#serverTime').textContent = serverTime.toLocaleDateString('id-ID', options);
      } catch (error) {
        console.error('Error updating server time:', error);
        // Fallback ke waktu lokal
        const localTime = new Date();
        $('#serverTime').textContent = localTime.toLocaleDateString('id-ID', {
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
      }
    }

    // Fungsi untuk memuat data user
    async function loadUserData() {
      try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        if (userDoc.exists) {
          userData = userDoc.data();
          $('#nama').value = userData.nama || '';
          $('#alamat').value = userData.alamat || '';
          
          // Update foto profil jika ada
          if (userData.photoURL) {
            $('#pfp').src = userData.photoURL;
          }
        }
      } catch (error) {
        console.error('Error loading user data:', error);
        toast('Gagal memuat data pengguna', 'error');
      }
    }

    // Fungsi untuk menyimpan data user
    async function saveUserData() {
      try {
        const nama = $('#nama').value.trim();
        const alamat = $('#alamat').value.trim();
        const pfpFile = $('#pfpFile').files[0];

        // Update data user
        await db.collection('users').doc(currentUser.uid).update({
          nama,
          alamat,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        userData = { ...userData, nama, alamat };
        toast('Profil berhasil disimpan', 'success');
        $('#profileDlg').close();
      } catch (error) {
        console.error('Error saving user data:', error);
        toast('Gagal menyimpan profil', 'error');
      }
    }

    // Fungsi untuk menerapkan filter
    async function applyFilters() {
      try {
        const nama = $('#fNama').value.trim();
        const periode = $('#fPeriode').value;
        const show = $('#fShow').value;
        
        let filters = { nama, periode };
        
        if (periode === 'custom') {
          filters.dari = $('#fDari').value;
          filters.sampai = $('#fSampai').value;
        }
        
        $('#applyFilter').disabled = true;
        $('#applyFilter').innerHTML = '<span class="spinner"></span> Memuat...';
        
        presenceHistory = await loadPresenceHistory(filters);
        renderPresenceTable(presenceHistory, show);
        
        $('#applyFilter').disabled = false;
        $('#applyFilter').innerHTML = '<span class="material-symbols-rounded">filter_alt</span> Terapkan';
        
        toast('Filter diterapkan', 'success');
      } catch (error) {
        console.error('Error applying filters:', error);
        toast('Gagal menerapkan filter', 'error');
        $('#applyFilter').disabled = false;
        $('#applyFilter').innerHTML = '<span class="material-symbols-rounded">filter_alt</span> Terapkan';
      }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', async function() {
      // Cek status autentikasi
      auth.onAuthStateChanged(async (user) => {
        if (!user) {
          window.location.href = 'index.html';
          return;
        }

        currentUser = user;
        
        // Load data user
        await loadUserData();
        
        // Update waktu server setiap detik
        updateServerTime();
        setInterval(updateServerTime, 1000);
        
        // Load data presensi awal
        await applyFilters();
      });
      
      // Period filter change
      $('#fPeriode').addEventListener('change', () => {
        const period = $('#fPeriode').value;
        $('#customDateRange').style.display = period === 'custom' ? 'flex' : 'none';
      });
      
      // Apply filters
      $('#applyFilter').addEventListener('click', applyFilters);
      
      // Export CSV
      $('#exportCsv').addEventListener('click', () => {
        const nama = $('#fNama').value.trim();
        const periode = $('#fPeriode').value;
        
        let filters = { nama, periode };
        
        if (periode === 'custom') {
          filters.dari = $('#fDari').value;
          filters.sampai = $('#fSampai').value;
        }
        
        exportToCSV(presenceHistory, filters);
      });
      
      // Profile dialog
      $('#profileBtn').addEventListener('click', () => {
        $('#profileDlg').showModal();
      });
      
      // Save profile
      $('#saveProfileBtn').addEventListener('click', saveUserData);
      
      // Logout
      $('#logoutBtn').addEventListener('click', () => {
        auth.signOut().then(() => {
          window.location.href = 'index.html';
        });
      });
    });
  </script>
</body>
</html>