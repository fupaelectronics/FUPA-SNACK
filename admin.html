<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Presensi FUPA — Admin</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#FFB300" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:FILL,GRAD@1,200" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <style>
    body{font-family:Inter,system-ui;margin:0;background:linear-gradient(180deg,#FFF59D,#FFB300);color:#222}
    header{display:flex;justify-content:space-between;padding:12px}
    .card{background:#fff;border-radius:12px;padding:12px;margin:12px}
    .btn{background:linear-gradient(135deg,#FFB300,#FF8F00);color:#fff;padding:8px;border-radius:8px;border:none;cursor:pointer}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eee}
    #toast{display:none;position:fixed;left:50%;bottom:12px;transform:translateX(-50%);padding:8px 12px;color:#fff;border-radius:8px}
  </style>
</head>
<body>
  <header>
    <div><b>Panel Admin</b><div id="serverTime" style="font-size:12px;opacity:.8">—</div></div>
    <div>
      <button id="notifBtn" class="btn">Permintaan Cuti <span id="notifBadge" style="background:red;color:#fff;border-radius:10px;padding:2px 6px;margin-left:6px">0</span></button>
      <button id="profileBtn" class="btn">Profil</button>
    </div>
  </header>

  <div class="card">
    <h3>Form Pengumuman</h3>
    <input id="pgJudul" placeholder="Judul" style="width:100%;padding:8px;margin:6px 0" />
    <textarea id="pgPesan" placeholder="Pesan" style="width:100%;padding:8px;margin:6px 0"></textarea>
    <select id="pgTarget" style="padding:8px;margin-right:6px">
      <option value="all">Semua</option>
      <option value="karyawan">Semua Karyawan</option>
    </select>
    <button id="pgSend" class="btn">Kirim</button>
  </div>

  <div class="card">
    <h3>Rekap Presensi</h3>
    <div>
      <input id="fNama" placeholder="Filter nama" style="padding:6px" />
      <select id="fPeriode" style="padding:6px">
        <option value="harian">Harian</option><option value="mingguan">Mingguan</option><option value="bulanan">Bulanan</option>
        <option value="tahunan">Tahunan</option><option value="custom">Periode Kustom</option>
      </select>
      <button id="exportCsv" class="btn">Download CSV</button>
    </div>
    <div id="tableWrap" style="margin-top:8px"></div>
  </div>

  <div id="toast"></div>

  <!-- Firebase + app.js -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script src="app.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyApYdiUlLMb9ihBkLnCjDpLJHqYFRFS3Fw",
      authDomain: "fupa-snack.firebaseapp.com",
      projectId: "fupa-snack",
      storageBucket: "fupa-snack.firebasestorage.app",
      messagingSenderId: "972524876738",
      appId: "1:972524876738:web:dd0d57dd8bf2d8a8dd9c5b"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const toastEl = document.getElementById('toast');
    function toast(msg, color='#111') {
      toastEl.style.backgroundColor = color;
      toastEl.textContent = msg;
      toastEl.style.display = 'block';
      setTimeout(()=> toastEl.style.display='none', 3000);
    }

    auth.onAuthStateChanged(async user => {
      if (!user) {
        toast('Akses admin: silakan login', '#c62828');
        setTimeout(()=> location.href='index.html', 800);
        return;
      }
      window.adminProfile = await FupaApp.loadProfileAndEnsure(user.uid);
      // ensure role is admin, otherwise redirect
      if (window.adminProfile.role !== 'admin') {
        toast('Akses ditolak: bukan admin', '#c62828');
        setTimeout(()=> auth.signOut().then(()=>location.href='index.html'),1200);
        return;
      }
      updateServerTime();
      setInterval(updateServerTime,1000);
      // listen notifications (admin)
      window.unsubscribeNotifs = FupaApp.listenNotificationsFor({uid:user.uid});
      window.onNotificationsUpdate = arr => {
        const unread = arr.filter(n => !n.isRead && (n.targetRole==='admin' || n.jenis==='cuti_request')).length;
        document.getElementById('notifBadge').textContent = unread;
      };
      loadTable();
    });

    function updateServerTime() {
      document.getElementById('serverTime').textContent = new Date().toLocaleString('id-ID');
    }

    // Pengumuman send
    document.getElementById('pgSend').addEventListener('click', async () => {
      const judul = document.getElementById('pgJudul').value.trim();
      const pesan = document.getElementById('pgPesan').value.trim();
      const target = document.getElementById('pgTarget').value;
      if (!judul || !pesan) { toast('Judul & pesan diperlukan', '#c62828'); return; }
      const pengumumanRef = await db.collection('pengumuman').add({
        judul, pesan, target, dibuatOleh: auth.currentUser.uid, timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      // create notifications
      if (target === 'all' || target === 'karyawan') {
        await db.collection('notifikasi').add({
          jenis: 'pengumuman',
          targetRole: 'karyawan',
          refId: pengumumanRef.id,
          pesan: judul,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          isRead: false
        });
      }
      toast('Pengumuman dikirim', '#2e7d32');
      document.getElementById('pgJudul').value=''; document.getElementById('pgPesan').value='';
    });

    // load presensi table
    async function loadTable() {
      const snap = await db.collection('presensi').orderBy('waktu','desc').limit(200).get();
      const wrap = document.getElementById('tableWrap');
      let html = '<table><thead><tr><th>Waktu</th><th>Nama</th><th>Jenis</th><th>Status</th><th>Koordinat</th><th>Selfie</th></tr></thead><tbody>';
      snap.forEach(d => {
        const r = d.data();
        const waktu = r.waktu && r.waktu.toDate ? r.waktu.toDate().toLocaleString('id-ID') : r.waktu || '-';
        html += `<tr><td>${waktu}</td><td>${r.nama||r.uid}</td><td>${r.jenis||''}</td><td>${r.status||''}</td><td>${r.koordinat||''}</td><td>${r.selfie?`<a href="${r.selfie}" target="_blank">Lihat</a>`:'-'}</td></tr>`;
      });
      html += '</tbody></table>';
      wrap.innerHTML = html;
    }

    document.getElementById('exportCsv').addEventListener('click', () => {
      FupaApp.exportCsv();
    });

    document.getElementById('notifBtn').addEventListener('click', async () => {
      // show cuti requests
      const snap = await db.collection('cuti').where('status','==','pending').orderBy('timestamp','desc').get();
      if (snap.empty) return alert('Tidak ada permintaan cuti.');
      let out = '';
      snap.forEach(d => {
        const r = d.data();
        out += `ID: ${d.id}\nNama: ${r.nama}\nTanggal: ${r.tanggal}\nJenis: ${r.jenis}\nKeterangan: ${r.keterangan}\n\n`;
      });
      const id = prompt('Daftar permintaan cuti (salin ID untuk proses). Semua:\n\n' + out + '\nMasukkan ID untuk proses:');
      if (!id) return;
      const action = prompt('Ketik "setujui" atau "tolak":');
      if (!action) return;
      try {
        await FupaApp.putuskanCuti(id, action.toLowerCase()==='setujui', auth.currentUser.uid, window.adminProfile.name || auth.currentUser.email);
        loadTable();
      } catch (e) {
        alert('Gagal memproses cuti: ' + e.message);
      }
    });

    document.getElementById('profileBtn').addEventListener('click', async () => {
      const nama = prompt('Nama admin:', window.adminProfile.name || '');
      const alamat = prompt('Alamat:', window.adminProfile.alamat || '');
      await db.collection('users').doc(auth.currentUser.uid).update({ name: nama, alamat });
      toast('Profil admin tersimpan', '#2e7d32');
    });
  </script>
</body>
</html>